<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Part Number Collector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        button {
            margin-right: 10px;
            padding: 10px 15px;
            cursor: pointer;
        }

        .status {
            margin-top: 10px;
            color: #333;
        }

        #partNumbersTable {
            font-family: 'Arial', sans-serif;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        #partNumbersTable th {
            background-color: #f2f2f2;
            text-align: left;
            padding: 12px;
        }

        #partNumbersTable td {
            padding: 8px;
            border-bottom: 1px solid #ccc;
        }

        /* Tooltip Icon and Tooltip Styles */
        .info-icon {
            display: inline-block;
            margin-left: 6px;
            position: relative;
            border: 1px solid #333;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            text-align: center;
            line-height: 16px;
            font-size: 14px;
            font-family: sans-serif;
            cursor: pointer;
            background-color: #eee;
        }


        .info-icon:hover .reason-tooltip {
            visibility: visible;
            opacity: 1;
        }


        .reason-tooltip {
            visibility: hidden;
            opacity: 0;
            background-color: #333;
            color: #fff;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 999;
            top: 25px;
            /* Position below the icon */
            left: 0;
            transition: opacity 0.2s, visibility 0.2s;
            display: block;
            /* Ensures proper width behavior */
            max-width: 600px;
            /* Adjust width to suit your needs */
            min-width: 300px;
            /* Prevents it from being too narrow */
            white-space: normal;
            /* Ensures text wraps properly */
            word-wrap: break-word;
            /* Prevents long words from breaking layout */
            text-align: left;
            /* Aligns text properly instead of center */
            font-size: 14px;
            /* Ensures readable font */
            line-height: 1.4;
            /* Adjusts spacing to look natural */
        }

        #progressContainer {
            width: 100%;
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
        }

        #progressBar {
            width: 0%;
            background: #4caf50;
            height: 20px;
            border-radius: 4px;
            text-align: center;
            color: white;
            line-height: 20px;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <h1>Part Number Collector</h1>
    <p>Type the parts you need in the box below, or click "Record" to speak them aloud.</p>
    <textarea id="partsInput" placeholder="1000 feet of 2-inch EMT..."></textarea><br />

    <button id="recordBtn">Record</button>
    <button id="submitBtn">Submit</button>

    <div class="status" id="statusMessage"></div>
    <!-- Progress bar container, hidden by default -->
    <div id="progressContainer"
        style="display: none; width: 100%; background: #eee; border: 1px solid #ccc; border-radius: 4px; margin-top: 10px;">
        <div id="progressBar"
            style="width: 0%; background: #4caf50; height: 20px; border-radius: 4px; text-align: center; color: white; line-height: 20px;">
            0%
        </div>
    </div>



    <!-- Table for displaying results -->
    <div id="partNumbersTableContainer" style="display: none; margin-top: 20px;">
        <h3>Part Numbers:</h3>
        <table id="partNumbersTable" style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <!-- Rows will be added dynamically -->
            </thead>
            <tbody>
                <!-- Rows will be added dynamically -->
            </tbody>
        </table>
    </div>

    <script>
        const GCF_ENDPOINT = 'https://us-central1-spring-archive-445317-n4.cloudfunctions.net/get-part-numbers';

        const submitBtn = document.getElementById('submitBtn');
        const partsInput = document.getElementById('partsInput');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const tableContainer = document.getElementById('partNumbersTableContainer');
        const table = document.getElementById('partNumbersTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');

        let isComplete = false;       // True once we've received the "complete" message.
        let hasReceivedData = false;  // True once we've received any data messages.
        let eventSource;

        submitBtn.addEventListener('click', async () => {
            progressContainer.style.display = 'block';
            const partsText = partsInput.value.trim();
            if (!partsText) {
                statusMessage.textContent = 'Please enter some part descriptions first.';
                return;
            }

            const descriptions = partsText.split(/\n+/); // Split by line breaks

            // Clear previous results.
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            tableContainer.style.display = 'block';
            statusMessage.style.display = 'block';
            statusMessage.textContent = `Submitting ${descriptions.length} part(s)...`;
            updateProgressBar(0);

            isComplete = false;
            hasReceivedData = false; // Reset for a new submission

            try {
                const url = `${GCF_ENDPOINT}?descriptions=${encodeURIComponent(JSON.stringify(descriptions))}`;
                eventSource = new EventSource(url);
                console.log("Connecting to:", url);

                eventSource.onopen = () => {
                    console.log("Connection opened.");
                };

                eventSource.onerror = (error) => {
                    // If we've already completed, do nothing (ignore).
                    if (isComplete) {
                        console.log("Ignoring error event after completion:", error);
                        return;
                    }
                    // If we haven't received any data yet, this is likely a genuine connection issue.
                    if (!hasReceivedData) {
                        console.error("EventSource connection failed before any data arrived:", error);
                        statusMessage.textContent = "Error: Connection lost.";
                    } else {
                        // We *have* received some data, so this error might just be the server closing or a final SSE glitch.
                        // Usually, we just log it or ignore it to avoid overwriting the UI.
                        console.warn("Late EventSource error after data was received:", error);
                    }
                    eventSource.close();
                };

                eventSource.onmessage = (event) => {
                    let data = {};
                    try {
                        data = JSON.parse(event.data);
                    } catch (err) {
                        console.error("Error parsing SSE data:", err);
                        return;
                    }

                    // Ignore heartbeat or empty updates
                    if (!data.description && !data.vendors && data.progress === undefined) {
                        return;
                    }

                    // We received meaningful data, so track that fact.
                    hasReceivedData = true;

                    // If the server sends back an error in the data itself
                    if (data.error) {
                        statusMessage.textContent = `Error: ${data.error}`;
                        eventSource.close();
                        return;
                    }

                    // Handle progress updates
                    if (data.progress !== undefined && !isNaN(data.progress)) {
                        const progressRounded = Math.round(data.progress);
                        statusMessage.textContent = `Processing... ${progressRounded}% complete`;
                        updateProgressBar(progressRounded);
                    }

                    // Append any vendor rows
                    if (data.description && data.vendors) {
                        appendRowToTable(data);
                    }

                    // If complete, finalize
                    if (data.complete) {
                        isComplete = true;
                        statusMessage.textContent = "All parts processed!";
                        updateProgressBar(100);

                        console.log("Final aggregated results:", data.results);

                        // Optionally hide the status message after a short delay
                        setTimeout(() => {
                            statusMessage.style.display = 'none';
                        }, 1000);

                        // Override the error handler so no future errors rewrite the status
                        eventSource.onerror = () => { };
                        eventSource.close();
                    }
                };
            } catch (error) {
                console.error('Submission error:', error);
                statusMessage.textContent = 'Error submitting parts to the server.';
            }
        });

        // Progress Bar
        function updateProgressBar(percentage) {
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        // Append Row
        function appendRowToTable(update) {
            const { description, vendors } = update;

            // Build header if empty
            if (tableHead.rows.length === 0 && vendors && vendors.length > 0) {
                const headerRow = document.createElement('tr');
                const descHeader = document.createElement('th');
                descHeader.textContent = "Description";
                headerRow.appendChild(descHeader);

                vendors.forEach(vendorResult => {
                    const vendorHeader = document.createElement('th');
                    vendorHeader.textContent = vendorResult.vendorDisplayName || vendorResult.vendor;
                    headerRow.appendChild(vendorHeader);
                });

                tableHead.appendChild(headerRow);
            }

            const newRow = document.createElement('tr');

            // Description cell
            const descriptionCell = document.createElement('td');
            descriptionCell.textContent = description;
            newRow.appendChild(descriptionCell);

            // One cell per vendor
            vendors.forEach(vendorResult => {
                const cell = document.createElement('td');
                if (vendorResult.partNumber && vendorResult.partNumber !== "N/A") {
                    const link = document.createElement('a');
                    link.href = getLinkPrefix(vendorResult.vendor) + vendorResult.partNumber;
                    link.target = '_blank';
                    link.textContent = vendorResult.partNumber;
                    cell.appendChild(link);
                } else {
                    cell.textContent = '-';
                }
                if (vendorResult.explanation) {
                    const infoIcon = document.createElement('span');
                    infoIcon.className = 'info-icon';
                    infoIcon.textContent = ' i';
                    const tooltip = document.createElement('span');
                    tooltip.className = 'reason-tooltip';
                    tooltip.textContent = vendorResult.explanation;
                    infoIcon.appendChild(tooltip);
                    cell.appendChild(infoIcon);
                }
                newRow.appendChild(cell);
            });

            tableBody.appendChild(newRow);
        }

        // Build URL prefix
        function getLinkPrefix(vendorName) {
            switch ((vendorName || "").toLowerCase()) {
                case 'border states':
                case 'borderstates':
                    return 'https://www.borderstates.com/p/';
                case 'graybar':
                    return 'https://www.graybar.com/p/';
                default:
                    return 'https://example.com/search?q=';
            }
        }
    </script>



</body>

</html>